# 1. 異常検知基礎
## 1.1 基礎
### 1.1.1 異常パターンの分類
- 異常検知の分野において「異常」を客観的に捉えるために異常パターンを分類する必要がある
- 外れ値: 値が他と比べて大きく離れている値
    - 外れ値を見つける問題を「外れ値検出」と呼ぶ
- 変化点: 値が他と異なった振る舞いをする、振る舞いが変化した時点
    - 変化点を見つける問題を「変化(点)検知」または「異常部位検知」と呼ぶ
### 1.1.2 異常度・閾値・誤報率
- 異常度: どれだけ異常かを定量的に示す数値
- 閾値: どれだけ異常度が高ければ異常と見做すか
- 誤報率: 正常なものを、異常だと判断してしまった割合
    - `1 - (正しく正常と判断した数)/(正常の数)`
## 1.2 ホテリング法
### 1.2.1 ホテリング法とは
- ホテリング法: データが単一の正規分布から発生しているという仮定のもとで、異常度と閾値を定義
- 制約: 
    - データが単一の正規分布から発生している
    - データ中に異常な値を含まないか、含んでいたとしてもごくわずか
- 手法:
    1. 自分で設定した誤報率に基づき、閾値を求める
    2. 正常と信用できる値の平均値および共分散行列を計算する
    3. テストデータに対してマハラノビス距離(異常度)を計算し、閾値を超えていたら異常と判定する

### 1.2.2 マハラノビス距離
- マハラノビス距離: あるデータがデータ全体の平均値からどれくらい離れているか
- ユークリッド距離の問題点: 
    - 分散の大きい変数の寄与が大きく、分散の小さい変数の寄与が小さい(スケールに左右される)
    - 変数同士の相関を反映できない
- マハラノビス距離の特性:
    - ユークリッド距離の問題点を、共分散行列の逆行列である逆共分散行列(精度行列)を噛ませて正規化することによって解決
        - スケール不変性
        - 特徴量間の相関を補正
- 実装例
```
from scipy.spatial import distance

# データ集合の平均値
# axis=0 と指定することで列ごとの平均を求めていく
mean = np.mean(data, axis=0)
# データ集合の共分散行列(分散を集めたもの)
cov = np.cov(data.T)
# データx, 平均値mean, 共分散行列の逆行列np.linalg.pinv(cov) から距離を計算
distance.mahalanobis(x, mean, np.linalg.pinv(cov))
```
### 1.2.3 T二乗法（閾値の決定）
- ホテリングのT二乗法: ホテリング法を用いた外れ値検出のこと
- 手順1. 自分で設定した誤報率に基づき、閾値を求める
    - 必要なパラメータである 誤報率は自身で設定
    - 誤報率を設定し、データ量が十分ある状態であれば、近似的にχ(カイ)二乗検定を用いて閾値を設定できる
- 実装例
```
from scipy import stats as st

# 異常度a, 次元数df, 誤報率f1
a = 10
df = 4
f1 = 0.05

# 閾値を計算
threshold = st.chi2.ppf(1 - f1, df)

# 閾値を越えているかによって分岐
if a <= threshold:
    print("normal")
else:
    print("abnormal")
```
### 1.2.4 T二乗法（標本値の計算）
- 手順2: 正常と信用できる値の平均値および共分散行列を計算する
    - データから平均値と共分散行列を計算
- 実装例
```
import numpy as np

# 平均値
mean = np.mean(data, axis=0)
# 共分散行列
cov = np.cov(data.T)
```
### 1.2.5 T二乗法（異常度の計算）
- 手順3. テストデータに対してマハラノビス距離を計算し、閾値を超えていたら異常と判定する
- 実装例
```
# xのマハラノビス距離
mahalanobis = distance.mahalanobis(x, mean, np.linalg.pinv(cov))
```
### 1.2.6 ホテリング法実践
- 実装例
```
import numpy as np
from scipy.spatial import distance
from scipy import stats as st
import matplotlib.pyplot as plt
import seaborn as sns

# X_testの読み込み
X_test = np.loadtxt('anomaly_detection_data/hoteling_test_data.csv', dtype='float64', delimiter=',')

# 閾値を設定して下さい
thr = st.chi2.ppf(1 - 0.15, 2)

# X_testの標本値を取得して下さい
mean = np.mean(X_test, axis=0)
cov = np.cov(X_test.T)

# X_testの各データの異常度mahを計算して下さい
mah = [distance.mahalanobis(x, mean, np.linalg.pinv(cov)) for x in X_test]

# X_err, X_normを分類して下さい
X_err = X_test[mah > thr]
X_nom = X_test[thr >= mah]

# プロットしています
plt.plot(X_err[:, 0], X_err[:, 1], "o", color="r")
plt.plot(X_nom[:, 0], X_nom[:, 1], "o", color="b")
plt.title("T二乗法によるX_testについての異常値検知")
plt.show()
```
## 1.3 単純ベイズ法
### 1.3.1 単純ベイズ法とは
### 1.3.2 ベクトルの重み
### 1.3.3 単純ベイズ分類（重みの計算）
### 1.3.4 単純ベイズ分類（閾値の最適化）
### 1.3.5 単純ベイズ分類（異常度の計算）
# 2. 外れ値検出
## 2.1 k近傍法
### 2.1.1 k近傍法とは
### 2.1.2 異常度
### 2.1.3 一つ抜き交差確認法
### 2.1.4 閾値の設定
### 2.1.5 k近傍法（異常判定）
## 2.2 1クラスSVM
### 2.2.1 1クラスSVMとは
### 2.2.2 異常度の計算
### 2.2.3 閾値の設定
### 2.2.4 1クラスSVM（異常判定）
## 2.3 方向データの異常検知
### 2.3.1 方向データについて
### 2.3.2 データの規格化
### 2.3.3 方向データの異常検知（異常度の計算）
### 2.3.4 方向データの異常検知（閾値の設定）
### 2.3.5 方向データの異常検知（異常判定）
# 3. 変化点検知
## 3.1 累積和法による変化検知
### 3.1.1 累積和法とは
### 3.1.2 変化度
### 3.1.3 上側累積和
### 3.1.4 異常判定
## 3.2 近傍法による異常部位検出
### 3.2.1 スライド窓と部分時系列
### 3.2.2 ラベル無しデータの最近傍法（異常度の計算）
### 3.2.3 ラベル無しデータの最近傍法（閾値の設定、異常判定）
## 3.3 特異スペクトル変換法
### 3.3.1 履歴行列とテスト行列
### 3.3.2 特異値分解
### 3.3.3 変化度の計算